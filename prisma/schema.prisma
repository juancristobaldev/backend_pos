generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                String             @id @default(uuid())
  name              String
  email             String             @unique
  password          String
  status            String

  businesses        Business[]
  subscriptions     Subscription[]
  subscriptionSales SubscriptionSale[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Business {
  id            String        @id @default(uuid())
  clientId      String
  name          String
  address       String
  phone         String
  currency      String
  taxRate       Float
  maxTables     Int
  theme         String?
  status        String

  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  users         User[]
  floors        Floor[]
  products      Product[]
  orders        Order[]
  sales         Sale[]
  
  chats         Chat[]
  notifications Notification[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model PaymentIntent {
  id           String   @id @default(uuid())

  orderId      String?  @unique

  amount       Int
  status       String

  token        String?
  buyOrder     String
  sessionId    String
  returnUrl    String

  type         String
  referenceId  String
  clientEmail  String

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model User {
  id         String      @id @default(uuid())
  businessId String
  name       String
  email      String      @unique
  password   String
  role       String
  status     String
  lastLogin  DateTime?

  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orders     Order[]
  sales      Sale[]
  histories  OrderHistory[]
  chats      Chat[]      @relation("ChatSender")

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model Floor {
  id         String   @id @default(uuid())
  businessId String
  name       String

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tables     Table[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Table {
  id        String   @id @default(uuid())
  floorId   String
  name      String
  coordX    Float
  coordY    Float
  capacity  Int
  status    String
  shape     String
  color     String

  sale Sale[]
  orders Order[]

  floor     Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String      @id @default(uuid())
  businessId  String
  name        String
  description String
  price       Int
  available   Boolean
  category    String

  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Order {
  id         String   @id @default(uuid())
  clientEmail String?
  businessId String
  userId     String
  tableId    String?
  saleId     String? 
  status     String
  subtotal   Int
  tax        Int
  discount   Int      @default(0)
  tip        Int      @default(0)
  total      Int

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  table      Table?   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  sale       Sale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  items      OrderItem[]
  histories  OrderHistory[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model OrderItem {
  id         String  @id @default(uuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Int
  total      Int
  note       String?

  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model OrderHistory {
  id             String   @id @default(uuid())
  orderId        String
  userId         String
  previousStatus String
  newStatus      String
  changedAt      DateTime @default(now())

  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Sale {
  id          String   @id @default(uuid())
  businessId  String
  userId      String
  order       Order[]
  clientEmail String?
  status      String

  subtotal    Int
  tax         Int
  discount    Int
  tip         Int
  total       Int

  tableId     String
  table       Table   @relation(fields: [tableId], references: [id], onDelete: Cascade)

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  closedAt    DateTime?
}

model Subscription {
  id          String   @id @default(uuid())
  clientId    String
  status      String
  price       Int
  interval    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sales       SubscriptionSale[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SubscriptionSale {
  id              String   @id @default(uuid())
  subscriptionId  String
  clientId        String
  amount          Int
  status          String

  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
}

model Chat {
  id         String   @id @default(uuid())
  businessId String
  senderId   String
  message    String
  type       String
  read       Boolean  @default(false)

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sender     User     @relation("ChatSender", fields: [senderId], references: [id], onDelete: Cascade)

  sentAt     DateTime @default(now())
}

model Notification {
  id         String   @id @default(uuid())
  businessId String
  type       String
  message    String
  read       Boolean  @default(false)

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
}

model SyncLog {
  id        String   @id @default(uuid())
  entity    String
  entityId  String
  operation String
  dataJson  String

  createdAt DateTime @default(now())
}
